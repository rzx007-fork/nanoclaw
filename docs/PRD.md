# NanoClaw 产品需求文档 (PRD)

| 文档版本 | 日期       | 作者     | 变更说明 |
| -------- | ---------- | -------- | -------- |
| v1.0     | 2025-02-24 | 产品团队 | 初始版本 |

---

## 1. 产品概述

### 1.1 产品定义

NanoClaw 是一个轻量级、安全的个人 AI 助手，基于 Claude Agent SDK 构建。它运行在容器隔离环境中，通过 WhatsApp 等即时通讯工具与用户交互，提供 AI 编程、任务自动化、信息查询等服务。

### 1.2 核心价值主张

| 价值点       | 描述                                                       |
| ------------ | ---------------------------------------------------------- |
| **极致轻量** | 单进程架构，代码库足够小，用户可在 8 分钟内完全理解        |
| **真正安全** | OS 级容器隔离，而非应用级权限检查，Agent 只能访问挂载目录  |
| **深度定制** | 每个用户 fork 后通过 Claude Code 定制，获得专属功能集      |
| **AI 原生**  | 无传统安装向导、监控面板、调试工具，AI 协助完成所有操作    |
| **技能扩展** | 通过技能（Skills）而非功能（Features）扩展，保持代码库整洁 |

### 1.3 与竞品对比

| 特性       | NanoClaw   | OpenClaw    | AutoGPT    |
| ---------- | ---------- | ----------- | ---------- |
| 代码规模   | ~5,000 行  | ~500,000 行 | ~50,000 行 |
| 进程数     | 1          | 53+         | 多进程     |
| 安全隔离   | 容器级     | 应用级      | 无         |
| 配置复杂度 | 无配置文件 | 70+ 配置项  | 中等       |
| 可理解性   | 极高       | 极低        | 中等       |

---

## 2. 目标用户

### 2.1 核心用户画像

**开发者/技术爱好者**

- 年龄：25-40 岁
- 职业：软件工程师、技术负责人、独立开发者
- 需求：通过手机快速执行编程任务、自动化脚本、代码审查
- 技术水平：熟悉终端、容器、Git

**知识工作者**

- 年龄：28-45 岁
- 职业：产品经理、数据分析师、研究人员
- 需求：信息检索、文档整理、日程管理、数据分析
- 技术水平：基本技术理解

### 2.2 用户场景

```
场景 1：移动端编程
用户在通勤途中收到 Bug 报告，通过 WhatsApp 发送：
"@Andy 检查 src/api.ts:150 附近的错误日志，找到根本原因并修复"

场景 2：定时任务自动化
用户设置每周一早上 8 点的简报：
"@Andy 每周一早上8点，从 Hacker News 收集 AI 领域重要资讯并发送摘要"

场景 3：团队协作管理
用户作为技术负责人，在群组中：
"@Andy 生成过去一周的 git commit 报告，统计每位成员的贡献"
```

---

## 3. 功能需求

### 3.1 核心功能

#### 3.1.1 消息交互

| 功能 ID | 功能名称   | 描述                                              | 优先级 |
| ------- | ---------- | ------------------------------------------------- | ------ |
| F-001   | 触发机制   | 支持 `@{name}` 触发词激活助手，默认 `@Andy`       | P0     |
| F-002   | 多群组隔离 | 每个 WhatsApp 群组独立上下文、记忆、文件系统      | P0     |
| F-003   | 主通道控制 | 自聊通道（self-chat）作为管理入口，可管理所有群组 | P0     |
| F-004   | 消息持久化 | 所有消息存储在 SQLite，支持历史回顾               | P1     |
| F-005   | 流式响应   | Agent 输出实时流式返回，显示正在输入状态          | P1     |

#### 3.1.2 容器隔离执行

| 功能 ID | 功能名称 | 描述                                                    | 优先级 |
| ------- | -------- | ------------------------------------------------------- | ------ |
| F-010   | 容器启动 | 为每个群组启动独立容器，挂载对应文件系统                | P0     |
| F-011   | 容器复用 | 活跃容器接收新消息，30 分钟空闲后关闭                   | P1     |
| F-012   | 并发控制 | 全局最多 5 个容器并发，按组队列管理                     | P1     |
| F-013   | 挂载安全 | 读取 `~/.config/nanoclaw/mount-allowlist.json` 验证挂载 | P0     |
| F-014   | 超时保护 | 容器默认 30 分钟超时，可配置                            | P1     |

#### 3.1.3 定时任务

| 功能 ID | 功能名称      | 描述                                          | 优先级 |
| ------- | ------------- | --------------------------------------------- | ------ |
| F-020   | Cron 表达式   | 支持 cron 语法定义周期性任务                  | P0     |
| F-021   | Interval 间隔 | 支持毫秒级间隔任务                            | P0     |
| F-022   | 单次执行      | 支持指定 ISO 时间戳单次执行                   | P0     |
| F-023   | 上下文模式    | `group` 模式复用会话，`isolated` 模式新建会话 | P1     |
| F-024   | 任务管理      | 暂停、恢复、取消任务，查看运行历史            | P1     |

#### 3.1.4 记忆系统

| 功能 ID | 功能名称   | 描述                                      | 优先级 |
| ------- | ---------- | ----------------------------------------- | ------ |
| F-030   | 组级记忆   | 每个 `groups/{name}/CLAUDE.md` 独立记忆   | P0     |
| F-031   | 全局记忆   | `groups/CLAUDE.md` 只读共享，仅主通道可写 | P0     |
| F-032   | 会话持久化 | Claude Agent SDK 自动管理会话状态         | P0     |
| F-033   | 文件操作   | Agent 可在组文件夹内读写文件              | P1     |

#### 3.1.5 IPC 通信

| 功能 ID | 功能名称 | 描述                                  | 优先级 |
| ------- | -------- | ------------------------------------- | ------ |
| F-040   | 消息发送 | Agent 通过 IPC 文件发送消息到任意群组 | P0     |
| F-041   | 任务调度 | Agent 可创建、管理定时任务            | P0     |
| F-042   | 群组注册 | 主通道可注册新群组到系统              | P0     |
| F-043   | 权限验证 | 非 main 群组只能操作自己的任务/消息   | P0     |

### 3.2 扩展功能

| 功能 ID | 功能名称        | 描述                        | 优先级 | 实现方式                           |
| ------- | --------------- | --------------------------- | ------ | ---------------------------------- |
| E-001   | 多通道支持      | Telegram、Discord、Slack    | P2     | 技能 `/add-telegram` 等            |
| E-002   | Gmail 集成      | 邮件读取和发送              | P2     | 技能 `/add-gmail`                  |
| E-003   | 语音转录        | WhatsApp 语音消息自动转文字 | P2     | 技能 `/add-voice-transcription`    |
| E-004   | X 集成          | 推文发布、转发、点赞        | P2     | 技能 `/x-integration`              |
| E-005   | Agent Swarm     | 多智能体协作团队            | P2     | 技能 `/add-telegram-swarm`         |
| E-006   | Apple Container | macOS 原生容器运行时        | P2     | 技能 `/convert-to-apple-container` |

---

## 4. 非功能性需求

### 4.1 性能要求

| 指标         | 目标值      | 说明                   |
| ------------ | ----------- | ---------------------- |
| 消息轮询间隔 | 2 秒        | 从 WhatsApp 拉取新消息 |
| IPC 处理延迟 | < 1 秒      | IPC 文件到消息发送     |
| 容器启动时间 | < 5 秒      | 冷启动容器并初始化     |
| 响应吞吐     | > 10 MB/min | Agent 输出流式速率     |
| 数据库查询   | < 100ms     | 单次查询耗时           |

### 4.2 可靠性要求

| 指标         | 目标值 | 说明                            |
| ------------ | ------ | ------------------------------- |
| 消息持久化   | 100%   | 所有消息必须写入 SQLite         |
| 容器崩溃恢复 | 自动   | 失败消息重新入队，最多 5 次重试 |
| 服务可用性   | 99%+   | 通过 launchd/systemd 守护       |
| 数据备份     | 定期   | 用户负责备份 `store/` 目录      |

### 4.3 安全要求

| 安全域   | 要求                                                           |
| -------- | -------------------------------------------------------------- |
| 容器隔离 | Agent 只能访问挂载目录，无法访问宿主机文件系统                 |
| 挂载验证 | 所有挂载请求必须通过 `~/.config/nanoclaw/mount-allowlist.json` |
| 权限控制 | 非 main 群组只能操作自己的任务和消息                           |
| 敏感信息 | 环境变量中的密钥不传递到容器，通过文件系统读取                 |
| 网络隔离 | 容器默认无网络访问，需要时显式配置                             |

### 4.4 可维护性要求

| 要求       | 说明                                       |
| ---------- | ------------------------------------------ |
| 代码可读性 | 单文件不超过 500 行，函数不超过 50 行      |
| 测试覆盖   | 核心模块单元测试覆盖率 > 80%               |
| 日志记录   | 使用结构化日志（pino），记录关键操作和错误 |
| 文档完整性 | 每个核心模块有详细注释和 JSDoc             |

### 4.5 兼容性要求

| 平台    | 支持状态    | 要求                                    |
| ------- | ----------- | --------------------------------------- |
| macOS   | ✅ 完全支持 | Node.js 20+, Docker 或 Apple Container  |
| Linux   | ✅ 完全支持 | Node.js 20+, Docker                     |
| WSL2    | ✅ 完全支持 | Node.js 20+, Docker                     |
| Windows | 🟡 部分支持 | 通过 WSL2（需要 `/setup-windows` 技能） |

---

## 5. 架构设计

### 5.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户层                                   │
│  WhatsApp   │  Telegram   │  Discord   │  Self-Chat (Main)     │
└─────────────┴─────────────┴────────────┴───────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      NanoClaw 主进程                            │
├─────────────────────────────────────────────────────────────────┤
│  消息轮询循环 (每 2s)                                            │
│      │                                                           │
│      ├──► 格式化消息 (router.ts)                                │
│      ├──► 按组队列管理 (group-queue.ts)                         │
│      │    ├──► 全局并发控制 (max 5)                             │
│      │    └──► 流式消息传递                                     │
│      │                                                           │
│      ├──► 容器启动 (container-runner.ts)                       │
│      │    ├──► Docker / Apple Container                         │
│      │    ├──► 挂载文件系统                                     │
│      │    └──► 流式输出处理                                     │
│      │                                                           │
│      ├──► 定时任务调度 (task-scheduler.ts, 每 60s)              │
│      └──► IPC 监听器 (ipc.ts, 每 1s)                            │
│           ├──► data/ipc/{group}/messages/                       │
│           └──► data/ipc/{group}/tasks/                          │
├─────────────────────────────────────────────────────────────────┤
│  数据层                                                          │
│  ├─── SQLite (store/messages.db)                              │
│  │    ├─── messages      # 消息历史                              │
│  │    ├─── chats         # 聊天元数据                            │
│  │    ├─── registered_groups  # 注册群组                       │
│  │    ├─── sessions      # Claude 会话                           │
│  │    └─── scheduled_tasks # 定时任务                            │
│  │                                                          │
│  └─── 文件系统                                                │
│       ├─── groups/{name}/           # 组文件夹                  │
│       │    ├─── CLAUDE.md           # 组记忆                    │
│       │    ├─── logs/               # 容器日志                  │
│       │    └─── {files}            # 用户文件                  │
│       └─── data/ipc/               # IPC 文件                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Agent 容器                                   │
├─────────────────────────────────────────────────────────────────┤
│  Claude Agent SDK + MCP Servers                                 │
│  ├─── nanoclaw MCP (调度、消息、任务管理)                        │
│  ├─── filesystem MCP (组文件系统访问)                            │
│  ├─── websearch MCP (网络搜索)                                  │
│  ├─── agent-browser (浏览器自动化)                               │
│  └─── Bash (在容器内安全执行)                                    │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 核心数据流

```
用户发送消息 (@Andy 帮我检查日志)
        │
        ▼
WhatsApp 接收消息
        │
        ▼
存储到 SQLite (store_message)
        │
        ▼
消息轮询循环 (每 2s)
        │
        ▼
检查触发词匹配 (@Andy)
        │
        ▼
GroupQueue.enqueueMessageCheck
        │
        ├──► 容器空闲？ ──► 是 ──► 通过 IPC 写入消息
        │                                  │
        │                                  ▼
        │                          容器读取 IPC 文件
        │                                  │
        │                                  ▼
        │                          Claude Agent 处理
        │                                  │
        │                                  ▼
        │                          结果写回 IPC (send_message)
        │                                  │
        │                                  ▼
        │                          IPC Watcher 读取
        │                                  │
        │                                  ▼
        │                          发送到 WhatsApp
        │
        └──► 否 ──► 启动新容器
                         │
                         ▼
                   挂载组文件夹
                         │
                         ▼
                   启动 Claude Agent
                         │
                         ▼
                   (同上流程)
```

### 5.3 模块依赖关系

```
index.ts (主入口)
├── config.ts
├── channels/whatsapp.ts
│   ├── types.ts
│   └── logger.ts
├── db.ts
│   ├── types.ts
│   ├── env.ts
│   └── config.ts
├── group-queue.ts
│   └── config.ts
├── container-runner.ts
│   ├── container-runtime.ts
│   ├── db.ts
│   ├── group-folder.ts
│   └── config.ts
├── task-scheduler.ts
│   ├── db.ts
│   ├── group-queue.ts
│   └── config.ts
└── ipc.ts
    ├── db.ts
    ├── group-folder.ts
    └── config.ts
```

---

## 6. 技术栈

### 6.1 后端技术

| 类别      | 技术                    | 版本  | 用途                   |
| --------- | ----------------------- | ----- | ---------------------- |
| 运行时    | Node.js                 | 20+   | 主要运行环境           |
| 语言      | TypeScript              | 5.7+  | 类型安全开发           |
| 数据库    | better-sqlite3          | 11.8+ | 消息、会话、任务持久化 |
| WebSocket | @whiskeysockets/baileys | 7.0+  | WhatsApp 连接          |
| 日志      | pino                    | 9.6+  | 结构化日志             |
| 定时      | cron-parser             | 5.5+  | Cron 表达式解析        |
| 测试      | vitest                  | 4.0+  | 单元测试               |

### 6.2 容器技术

| 运行时          | 平台   | 优势               |
| --------------- | ------ | ------------------ |
| Docker          | 跨平台 | 成熟生态，广泛支持 |
| Apple Container | macOS  | 原生性能，轻量级   |

### 6.3 AI 能力

| 技术                         | 提供方    | 用途         |
| ---------------------------- | --------- | ------------ |
| Claude Agent SDK             | Anthropic | Agent 框架   |
| Claude Code                  | Anthropic | 最佳工具套件 |
| MCP (Model Context Protocol) | Anthropic | 工具集成标准 |

---

## 7. 用户故事

### 7.1 MVP 用户故事

| ID     | 用户故事                                 | 验收标准                                                                    |
| ------ | ---------------------------------------- | --------------------------------------------------------------------------- |
| US-001 | 作为开发者，我想通过手机快速修复代码 bug | 在群组发送 `@Andy 修复 src/api.ts:150 的错误`，容器启动、代码修复、回复结果 |
| US-002 | 作为产品经理，我想每周一自动接收行业简报 | 创建 cron 任务，周一早上收到来自 HN 的 AI 资讯摘要                          |
| US-003 | 作为团队负责人，我想管理多个项目的群组   | 主通道注册 3 个群组，各自独立上下文，互不干扰                               |
| US-004 | 作为用户，我想让助手记住我的偏好         | 在群组聊天中说明偏好，后续对话自动应用                                      |
| US-005 | 作为安全意识用户，我想确保代码安全       | 所有 Agent 操作在容器内执行，无法访问宿主机敏感文件                         |

### 7.2 扩展用户故事

| ID     | 用户故事                           | 优先级 |
| ------ | ---------------------------------- | ------ |
| US-101 | 我想在 Telegram 上使用助手         | P2     |
| US-102 | 我想让助手读取和发送 Gmail         | P2     |
| US-103 | 我想用语音发送指令，自动转文字     | P2     |
| US-104 | 我想让助手发布推文到 X             | P2     |
| US-105 | 我想组建多个专业智能体协作完成任务 | P2     |

---

## 8. 实施计划

### 8.1 里程碑

| 里程碑 | 阶段          | 交付物                             | 完成日期  |
| ------ | ------------- | ---------------------------------- | --------- |
| M1     | 基础框架      | 单进程、SQLite、消息轮询           | ✅ 已完成 |
| M2     | 容器隔离      | Docker 集成、挂载系统、安全验证    | ✅ 已完成 |
| M3     | WhatsApp 集成 | baileys 连接、认证、收发消息       | ✅ 已完成 |
| M4     | 任务调度      | Cron/Interval/Once 任务管理        | ✅ 已完成 |
| M5     | IPC 通信      | 文件系统 IPC、权限控制             | ✅ 已完成 |
| M6     | 生产部署      | launchd/systemd 服务、日志、监控   | ✅ 已完成 |
| M7     | 技能系统      | `/setup`, `/customize` 等 10+ 技能 | ✅ 已完成 |
| M8     | 扩展通道      | Telegram、Discord、Slack           | 🔄 进行中 |
| M9     | 集成扩展      | Gmail、X、语音转录                 | 📋 计划中 |
| M10    | Agent Swarm   | 多智能体协作                       | 📋 计划中 |

### 8.2 MVP 路线图（已完成）

```
Week 1-2:   核心架构
  ├─ 单进程设计
  ├─ SQLite 数据库设计
  └─ 消息轮询循环

Week 3-4:   容器集成
  ├─ Docker 容器启动
  ├─ 文件系统挂载
  └─ 安全验证机制

Week 5-6:   WhatsApp 集成
  ├─ baileys 库集成
  ├─ 二维码认证流程
  └─ 消息收发实现

Week 7-8:   高级功能
  ├─ 定时任务调度器
  ├─ IPC 文件通信
  └─ 多群组隔离

Week 9-10:  生产化
  ├─ 服务守护进程
  ├─ 日志和错误处理
  └─ 技能系统框架
```

---

## 9. 风险分析

### 9.1 技术风险

| 风险              | 影响 | 概率 | 缓解措施                     |
| ----------------- | ---- | ---- | ---------------------------- |
| 容器安全性绕过    | 高   | 低   | 严格挂载验证，定期安全审计   |
| 并发死锁          | 中   | 中   | 优雅降级，超时机制           |
| 数据库锁竞争      | 中   | 中   | SQLite WAL 模式，连接池      |
| WhatsApp API 变更 | 高   | 中   | 使用稳定版 baileys，监控变更 |

### 9.2 产品风险

| 风险             | 影响 | 概率 | 缓解措施                         |
| ---------------- | ---- | ---- | -------------------------------- |
| 用户学习曲线陡峭 | 中   | 高   | `/setup` 技能引导，文档完善      |
| 竞品压力         | 高   | 中   | 差异化定位（安全轻量），技能生态 |
| 依赖服务中断     | 高   | 低   | 通道抽象层，支持多通道切换       |

### 9.3 运营风险

| 风险         | 影响 | 概率 | 缓解措施                         |
| ------------ | ---- | ---- | -------------------------------- |
| 社区活跃度低 | 中   | 中   | Discord 社区运营，技能贡献激励   |
| 贡献者流失   | 低   | 中   | 代码库小，易于理解，降低贡献门槛 |

---

## 10. 成功指标

### 10.1 产品指标

| 指标         | 目标值      | 衡量方式          |
| ------------ | ----------- | ----------------- |
| 代码规模     | < 10,000 行 | 行数统计工具      |
| 单文件行数   | < 500 行    | 代码审查          |
| 测试覆盖率   | > 80%       | vitest 覆盖率报告 |
| 容器启动时间 | < 5 秒      | 性能测试          |

### 10.2 用户指标

| 指标              | 目标值   | 衡量方式               |
| ----------------- | -------- | ---------------------- |
| 安装成功率        | > 95%    | 技能执行日志           |
| 用户留存（30 天） | > 60%    | Docker Hub 拉取统计    |
| 技能贡献数        | > 20 个  | `.claude/skills/` 目录 |
| 社区成员          | > 100 人 | Discord 成员数         |

### 10.3 质量指标

| 指标         | 目标值 | 衡量方式      |
| ------------ | ------ | ------------- |
| 线上 Bug 率  | < 5%   | GitHub Issues |
| 平均响应时间 | < 3 秒 | 日志分析      |
| 容器崩溃率   | < 1%   | 错误日志统计  |

---

## 11. 附录

### 11.1 术语表

| 术语             | 定义                                               |
| ---------------- | -------------------------------------------------- |
| **Agent**        | AI 智能体，运行 Claude Agent SDK，具备工具使用能力 |
| **Container**    | Linux 容器，提供文件系统和进程隔离                 |
| **Group**        | WhatsApp 群组或自聊通道，具有独立上下文            |
| **Main Channel** | 自聊通道，具备管理权限，可操作所有群组             |
| **IPC**          | 进程间通信，通过文件系统实现                       |
| **Skill**        | Claude Code 技能，自动化修改代码库的指令集         |
| **MCP**          | Model Context Protocol，Anthropic 的工具集成标准   |

### 11.2 参考文档

- [README.md](README.md) - 项目介绍和快速开始
- [REQUIREMENTS.md](docs/REQUIREMENTS.md) - 原始需求和设计决策
- [SECURITY.md](docs/SECURITY.md) - 安全模型详解
- [SDK_DEEP_DIVE.md](docs/SDK_DEEP_DIVE.md) - Claude Agent SDK 深度分析

### 11.3 变更历史

| 版本 | 日期       | 变更内容                   |
| ---- | ---------- | -------------------------- |
| v1.0 | 2025-02-24 | 初始版本，完整产品需求定义 |

---

**文档状态**: ✅ 已审批
**下次审查日期**: 2025-05-24
